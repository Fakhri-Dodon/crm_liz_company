import{r as k,a as q,u as M,j as e,c as A}from"./app-D-CXuYp-.js";import{B as X,h as z}from"./html2pdf-tN8WAVVN.js";import{F as G,n as T}from"./index-Dml3iHVq.js";import{T as Q}from"./trash-2-C428PtZi.js";import"./useTranslation-C5DOJpQ8.js";import"./createLucideIcon-Da68c0mB.js";function te({nextNumber:R,leads:v=[],companies:w=[],quotations:I=[]}){const[$,S]=k.useState(!1),[y,C]=k.useState({name:"",processing:"",price:""}),{props:f}=q(),{auth:P,app_config:N}=f,D=t=>{const g={...t,id:Date.now()+Math.random(),price:Number(t.price)||0};console.log("Menambahkan item dengan ID:",g.id),d("services",[...s.services,g])},O=t=>{if(typeof t=="object"&&t!==null){const b=t.next_number??t.nextNumber??1,a=t.padding??4,i=t.prefix??"",p=String(b||1).padStart(a,"0");return`${i}${p}`}const g=typeof t=="object"&&t!==null?t.nextNumber:t;return`INV/${String(g||1).padStart(4,"0")}`},{data:s,setData:d,post:H,processing:K}=M({document_type:"INVOICE",client_type:null,date:"",number:O(R),prepared_by_name:P?.user?.name||"",prepared_by_role:P?.user?.role_name||"",my_company_name:N?.company_name||"",company_id:null,company_name:null,address:"",contact_person:"",position:"",email:"",phone:"",quotation_id:"",payment_type:"",payment_percentage:0,payment_terms:"",note:"",services:[],ppn:0,pph:0,down_payment:0,sub_total:0,tax_amount_ppn:0,tax_amount_pph:0,total:0});k.useEffect(()=>{const t=s.services.reduce((n,l)=>n+Number(l.price||0),0),g=Number(s.ppn||0),x=Number(s.pph||0),b=Number(s.payment_percentage||0),a=t*g,i=t*x,p=t*b,u=t+a-i;(s.sub_total!==t||s.total!==u||s.tax_amount_ppn!==a||s.tax_amount_pph!==i||s.down_payment!==p)&&d(n=>({...n,sub_total:t,tax_amount_ppn:a,tax_amount_pph:i,down_payment:p,total:u}))},[s.services,s.ppn,s.pph,s.payment_percentage]);const B=async()=>{if(s.services.length===0){alert("Peringatan: Anda harus menambahkan setidaknya satu jasa/layanan sebelum menyimpan.");return}if(!s.company_id){alert("Pilih client");return}try{console.log("=== START SAVE INVOICE ==="),console.log("Current data:",s);const t=document.getElementById("quotation-pdf");if(!t)throw new Error("Element quotation-pdf not found");console.log("Generating PDF...");const g={margin:0,filename:`${s.number}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}},x=await z().set(g).from(t).output("blob");console.log("PDF generated, size:",x.size);const b=new FormData;console.log("Building FormData..."),Object.keys(s).forEach(a=>{if(a==="services"){const i=Array.isArray(s.services)?s.services:[];b.append("services",JSON.stringify(i)),console.log("Services:",i)}else s[a]!==null&&s[a]!==void 0&&b.append(a,s[a])}),b.append("pdf_file",x,`${s.number}.pdf`),console.log("FormData entries:");for(let a of b.entries())a[0]!=="pdf_file"&&console.log(a[0]+":",a[1]);console.log("Posting to server..."),A.post(route("invoice.store"),b,{onSuccess:a=>{console.log("Success response:",a),T.success("Berhasil disimpan!",{style:{border:"1px solid #4ade80",padding:"16px",color:"#166534"},iconTheme:{primary:"#4ade80",secondary:"#FFFAEE"}})},onError:a=>{console.error("=== ERROR FROM SERVER ==="),console.error("Errors object:",a),console.error("Error keys:",Object.keys(a)),Object.keys(a).forEach(p=>{console.error(`${p}:`,a[p]),T.error(`${p}: ${a[p]}`,{duration:5e3})});const i=Object.entries(a).map(([p,u])=>`${p}: ${u}`).join(`
`);alert(`Error:
`+i)},onFinish:()=>{console.log("Request finished")}})}catch(t){console.error("=== CATCH ERROR ==="),console.error("Error message:",t.message),console.error("Error stack:",t.stack),console.error("Full error:",t),alert("Error: "+t.message)}},L=()=>{A.get("/invoice")},j=t=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",maximumFractionDigits:0}).format(t);return N?.doc_logo_path&&`${N.doc_logo_path}`,e.jsxs(e.Fragment,{children:[$&&e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[9999]",children:e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-2xl w-[400px] border border-gray-200",children:[e.jsx("h3",{className:"font-black text-gray-800 mb-4 uppercase tracking-tight text-sm",children:"Add New Service"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] font-bold uppercase text-gray-400",children:"Service Name"}),e.jsx("input",{className:"w-full border-gray-300 rounded-lg p-2 text-sm",placeholder:"Sertifikasi Alat",value:y.name,onChange:t=>C({...y,name:t.target.value})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] font-bold uppercase text-gray-400",children:"Qualification"}),e.jsx("input",{className:"w-full border-gray-300 rounded-lg p-2 text-sm",placeholder:"Kualifikasi Kecil, BG001, BG002, BG003",value:y.processing,onChange:t=>C({...y,processing:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] font-bold uppercase text-gray-400",children:"Price"}),e.jsx("input",{type:"number",className:"w-full border-gray-300 rounded-lg p-2 text-sm",placeholder:"0",value:y.price,onChange:t=>C({...y,price:t.target.value})})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 mt-8",children:[e.jsx("button",{onClick:()=>S(!1),className:"px-4 py-2 text-sm font-bold text-gray-400",children:"CANCEL"}),e.jsx("button",{onClick:()=>{if(!y.name||!y.price)return alert("Lengkapi data!");D(y),S(!1),C({name:"",processing:"",price:""})},className:"bg-[#2d6a4f] text-white px-6 py-2 rounded-lg font-bold text-sm shadow-lg",children:"ADD ITEM"})]})]})}),e.jsx(G,{position:"top-right"}),e.jsx(X,{title:"Invoice Builder",data:s,setData:d,onSave:B,onBack:L,renderEditor:({updateField:t})=>{const g=!s.client_type,x=(n,l,c,r)=>{const o=(n||[]).reduce((E,V)=>E+Number(V.price||0),0),m=o*l,h=o*c,_=o*r,F=o+m-h;t("sub_total",o),t("tax_amount_ppn",m),t("tax_amount_pph",h),t("down_payment",_),t("total",F),d(E=>({...E,sub_total:o,tax_amount_ppn:m,tax_amount_pph:h,down_payment:_,total:F,services:n}))},b=n=>{const l=s.client_type==="Client",r=(l?w:v).find(o=>String(o.id)===String(n));if(r){const o=l?r.lead:r,m={company_id:r.id,lead_id:l?r.lead_id:r.id,company_name:l?r.lead?.company_name||r.client_code:r.company_name,address:o?.address||"",contact_person_id:"",contact_person:"",email:"",phone:"",position:""};Object.entries(m).forEach(([h,_])=>t(h,_)),d(h=>({...h,...m}))}},a=s.client_type==="Client"?w||[]:v||[],i=n=>{const l=s.client_type==="Client",r=(l?w:v).find(o=>String(o.id)===String(s.company_id));if(r){let o=null;if(l?o=r.contact_persons?.find(m=>String(m.id)===String(n)):o=r,o){const m={contact_person_id:n,contact_person:l?o.lead?.contact_person||r.lead?.contact_person||"---":r.contact_person||"",email:l?o.lead?.email||r.lead?.email||"":o.email||"",phone:l?o.lead?.phone||r.lead?.phone||"":o.phone||"",position:l?o.position||"":r.job_title||r.position||""};console.log("Data yang dikirim ke builder:",m),Object.entries(m).forEach(([h,_])=>{typeof t=="function"&&t(h,_)}),d(h=>({...h,...m}))}}},p=n=>{let l=0;n&&n!=="0"&&(l=Number(n)),t("ppn",l),d(c=>({...c,ppn:l})),x(s.services,l,s.pph,s.payment_percentage)},u=n=>{let l=0;n&&n!=="0"&&(l=Number(n)),t("pph",l),d(c=>({...c,pph:l})),x(s.services,s.ppn,l,s.payment_percentage)};return e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:["Date",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsx("input",{type:"date",className:"w-full border-gray-300 rounded text-sm",value:s.date||"",onChange:n=>{t("date",n.target.value),d("date",n.target.value)}})]}),e.jsx("div",{className:"flex bg-gray-100 p-1 rounded-xl",children:["Client","Lead"].map(n=>{const l=s.client_type===n;return e.jsx("button",{type:"button",onClick:c=>{c.preventDefault();const r=n;t("client_type",r),d("client_type",r),d(o=>({...o,client_type:r,company_id:null,company_name:null,contact_person_id:null})),console.log("State updated to:",r)},className:`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${l?"bg-[#065f46] text-white shadow-md":"text-gray-400"}`,children:n.toUpperCase()},n)})}),e.jsxs("div",{className:g?"opacity-40 pointer-events-none":"",children:[e.jsxs("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:["Select Company",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsxs("select",{className:"w-full border-gray-300 rounded text-sm",value:s.company_id||"",onChange:n=>b(n.target.value),children:[e.jsxs("option",{value:"",children:["-- Choose ",s.client_type," --"]}),a.map(n=>e.jsx("option",{value:n.id,children:s.client_type==="Client"?n.lead?.company_name||n.client_code:n.company_name},n.id))]})]}),e.jsxs("div",{className:`space-y-1 ${s.company_name?"":"opacity-40"}`,children:[e.jsxs("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:["Select Contact Person",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsxs("select",{className:"w-full border-gray-300 rounded text-sm",value:s.contact_person_id||"",onChange:n=>i(n.target.value),children:[e.jsx("option",{value:"",children:"-- Choose Person --"}),(()=>{const n=s.client_type==="Client",c=(n?w:v).find(o=>String(o.id)===String(s.company_id));if(!c)return null;let r=c.contact_persons||[];return r.length===0&&!n&&(r=[{id:c.id}]),r.map(o=>{const m=n?c.lead?.contact_person||"No Name":c.contact_person||"No Name",h=n&&o.position?` (${o.position})`:"";return e.jsxs("option",{value:o.id,children:[m,h]},o.id)})})()]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Quotation - Accepted"}),e.jsxs("select",{className:"w-full border-gray-300 rounded text-sm",value:s.quotation_id||"",onChange:n=>{t("quotation_id",n.target.value),d("quotation_id",n.target.value)},children:[e.jsx("option",{value:"",children:"-- Choose Quotation --"}),I.map(n=>e.jsxs("option",{value:n.id,children:[n.no," -"," ",n.company_name||n.lead?.company_name]},n.id))]})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:["Payment Type",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsxs("select",{className:"w-full border-gray-300 rounded text-sm",value:s.payment_type||"",onChange:n=>{const l=n.target.value;t("payment_type",l),d("payment_type",l);const c=(f.paymentTypes||[]).find(o=>o.name===l||o.slug===l);console.log("Selected payment type:",c),!!c&&(c.slug==="full_payment"||c.slug==="full-payment"||String(c.name||"").toLowerCase().includes("full"))?(t("payment_percentage",1),d("payment_percentage",1),x(s.services,s.ppn,s.pph,1)):c&&(c.slug==="down_payment"||c.slug==="down-payment"||String(c.name||"").toLowerCase().includes("down"))?(console.log("Selected Down Payment - resetting payment_percentage to 0"),t("payment_percentage",0),d("payment_percentage",0),x(s.services,s.ppn,s.pph,0)):console.log("Other payment type selected - leaving payment_percentage unchanged")},children:[e.jsx("option",{value:"",children:"-- Choose Payment --"}),(f.paymentTypes||[]).map(n=>e.jsx("option",{value:n.name,children:n.name},n.id))]})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Payment Percentage (10 = 10%)"}),e.jsx("input",{type:"number",step:"1",min:"0",max:"100",className:"w-full border-gray-300 rounded text-sm font-bold",value:s.payment_percentage?s.payment_percentage*100:"",onChange:n=>{const l=n.target.value,c=l===""?"":Number(l),r=c===""?"":Number(c)/100;t("payment_percentage",r),d("payment_percentage",r),x(s.services,s.ppn,s.pph,r)}})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"PPN"}),e.jsxs("select",{className:"w-full border-gray-300 rounded text-sm",value:s.ppn||0,onChange:n=>p(n.target.value),children:[e.jsx("option",{value:"0",children:"-- No PPN --"}),(f.ppn||[]).map(n=>e.jsx("option",{value:n.rate,children:n.name},n.id))]})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"PPh"}),e.jsxs("select",{className:"w-full border-gray-300 rounded text-sm",value:s.pph||0,onChange:n=>u(n.target.value),children:[e.jsx("option",{value:"0",children:"-- No PPh --"}),(f.pph||[]).map(n=>e.jsx("option",{value:n.rate,children:n.name},n.id))]})]}),e.jsxs("div",{className:"flex flex-col justify-start",children:[e.jsxs("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:["Payment Terms",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsx("textarea",{rows:"3",className:"w-full border-gray-300 rounded text-sm font-bold",value:s.payment_terms||"",onChange:n=>{const l=n.target.value;t("payment_terms",l),d("payment_terms",l)}})]}),e.jsxs("div",{className:"flex flex-col justify-start",children:[e.jsxs("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:["Note",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsx("textarea",{rows:"3",className:"w-full border-gray-300 rounded text-sm font-bold",value:s.note||"",onChange:n=>{const l=n.target.value;t("note",l),d("note",l)}})]})]})]})},renderPreview:({data:t,addItem:g,removeItem:x,updateField:b})=>(D||setBuilderAddItem(()=>g),k.useEffect(()=>{const a=t.services.reduce((o,m)=>o+Number(m.price||0),0),i=Number(t.ppn)||0,p=Number(t.pph)||0,u=Number(t.payment_percentage||0),n=a*i,l=a*p,c=a*u,r=a+n-l;(t.sub_total!==a||t.total!==r||t.tax_amount_ppn!==n||t.tax_amount_pph!==l||t.down_payment!==c)&&d(o=>({...o,sub_total:a,tax_amount_ppn:n,tax_amount_pph:l,down_payment:c,total:r}))},[t.services,t.ppn,t.pph,t.payment_percentage]),e.jsxs("div",{className:"p-2 text-[12px]",children:[e.jsxs("div",{className:"flex justify-between pb-4 mb-6",children:[e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Number"}),e.jsx("p",{className:"font-bold",children:t.number||"INV-XXXXX"})]}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Date"}),e.jsx("p",{className:"font-bold",children:t.date||"Date Not Set"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-8 mb-8",children:[e.jsx("div",{className:"border border-black p-5 rounded-sm",children:e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"To:"}),e.jsx("p",{className:"font-bold text-emerald-800",children:t.contact_person||"---"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Email:"}),e.jsx("p",{className:"text-black",children:t.email})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Handphone:"}),e.jsx("p",{className:"text-black",children:t.phone})]})]})}),e.jsx("div",{className:"border border-black p-5 rounded-sm",children:e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Company:"}),e.jsx("p",{className:"font-black",children:t.company_name||"---"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Address:"}),e.jsx("p",{className:"text-black leading-tight",children:t.address||"No address provided."})]})]})})]}),e.jsx("p",{className:"text-[15px] font-bold text-black mb-2",children:"Services"}),e.jsxs("table",{className:"w-full border-collapse border border-black",children:[e.jsx("thead",{className:"bg-gray-50 uppercase text-[10px] font-black border-b border-black",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 text-center w-8 border border-black",children:"No"}),e.jsx("th",{className:"p-2 text-left border border-black",children:"Description"}),e.jsx("th",{className:"p-2 text-center w-24 border border-black",children:"Qualification"}),e.jsx("th",{className:"p-2 text-right w-32",children:"Price"}),e.jsx("th",{"data-html2canvas-ignore":"true",className:"print:hidden p-2 w-10"})]})}),e.jsx("tbody",{children:t.services.map((a,i)=>e.jsxs("tr",{className:"border-b border-gray-100 relative group",children:[e.jsx("td",{className:"p-2 text-center font-bold text-gray-400 border border-black",children:t.services.indexOf(a)+1}),e.jsx("td",{className:"p-2 font-bold uppercase border border-black",children:a.name}),e.jsx("td",{className:"p-2 text-center border border-black",children:a.processing}),e.jsx("td",{className:"p-2 text-right font-black border-b border-black",children:j(a.price)}),e.jsx("td",{className:"print:hidden p-2 text-center border-b border-black",children:e.jsx("button",{type:"button","data-html2canvas-ignore":"true",onClick:()=>{console.log("ID Item ini adalah:",a.id),x(a.id)},className:"text-red-400 hover:text-red-600 transition-colors",children:e.jsx(Q,{size:14})})})]},a.id||i))})]}),e.jsx("div",{"data-html2canvas-ignore":"true",className:"mt-4 flex justify-start print:hidden",children:e.jsx("button",{"data-html2canvas-ignore":"true",onClick:()=>S(!0),className:"flex items-center gap-2 bg-[#065f46] text-white px-4 py-2 rounded-sm text-[10px] font-bold tracking-widest hover:scale-105 transition-all shadow-lg",children:"ADD SERVICE"})}),e.jsxs("div",{className:"mt-10 flex justify-between",children:[e.jsxs("div",{className:"w-1/2",children:[e.jsxs("div",{className:"h-[6rem] mb-5",children:[e.jsx("p",{className:"text-[15px] font-black font-bold mb-1",children:"Payment Terms"}),e.jsx("p",{className:"text-red-600 text-[11px] font-medium leading-tight whitespace-pre-wrap",children:t.payment_terms})]}),e.jsxs("div",{className:"h-[3rem] mb-20",children:[e.jsx("p",{className:"text-[15px] font-black font-bold mb-1",children:"Note"}),e.jsx("p",{className:"text-red-600 text-[11px] font-medium leading-tight whitespace-pre-wrap",children:t.note})]})]}),e.jsxs("div",{className:"w-1/3 space-y-1 font-bold",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:j(t.sub_total||0)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:(()=>{const a=t.payment_percentage?`${(t.payment_percentage*100).toFixed(0)}%`:"",i=Number(t.payment_percentage)===1,p=(f.paymentTypes||[]).find(n=>n.name===t.payment_type||n.slug===t.payment_type||n.name===t.payment_type);return i||p&&(p.slug==="full_payment"||p.slug==="full-payment"||String(p.name||"").toLowerCase().includes("full"))?`Paid in Full ${a?`(${a})`:""}`:`Down Payment ${a}`})()}),e.jsx("span",{children:j(t.down_payment||0)})]}),e.jsxs("div",{className:"flex justify-between text-red-600",children:[e.jsxs("span",{children:["VAT (PPN)"," ",(()=>{const a=f.ppn||[],i=Number(t.ppn||0),p=a.find(u=>Number(u.rate)===i);return p?p.name:i?`${(i*100).toFixed(0)}%`:""})()]}),e.jsx("span",{children:j(t.tax_amount_ppn||0)})]}),e.jsxs("div",{className:"flex justify-between text-red-600 border-b border-black pb-1",children:[e.jsxs("span",{children:["VAT (PPh)"," ",(()=>{const a=f.pph||[],i=Number(t.pph||0),p=a.find(u=>Number(u.rate)===i);return p?p.name:i?`${(i*100).toFixed(0)}%`:""})()]}),e.jsx("span",{children:j(t.tax_amount_pph||0)})]}),e.jsxs("div",{className:"flex justify-between text-sm font-black pt-1",children:[e.jsx("span",{children:"TOTAL"}),e.jsx("span",{children:j(t.total||0)})]}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-[16px] uppercase font-black",children:t.my_company_name||N?.company_name||"---"}),e.jsx("div",{className:"h-20"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-[14px] uppercase font-black leading-tight",children:t.prepared_by_name||P?.user?.name||"---"}),e.jsx("p",{className:"text-[13px] text-gray-500 leading-tight",children:t.prepared_by_role||P?.user?.role_name||"---"})]})]})]})]}),e.jsx("div",{className:"mt-10 p-3 bg-slate-100 rounded-md border border-slate-200",children:e.jsx("p",{className:"text-[12px] text-gray-600",children:N?.address})})]}))})]})}export{te as default};
