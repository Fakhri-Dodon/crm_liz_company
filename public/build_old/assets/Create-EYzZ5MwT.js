import{r as C,u as V,a as q,j as e,c as D}from"./app--V8YQuQk.js";import{B as M,h as L}from"./html2pdf-CvayzF7q.js";import{F as X,n as A}from"./index-DvGSOaWZ.js";import{T as z}from"./trash-2-D2TdDDoH.js";import"./useTranslation-DGCn9e9S.js";import"./createLucideIcon-D7A-7CJ7.js";function U({nextNumber:F,leads:_=[],companies:v=[],quotations:R=[]}){const[T,k]=C.useState(!1),[f,w]=C.useState({name:"",processing:"",price:""}),S=t=>{const u={...t,id:Date.now()+Math.random(),price:Number(t.price)||0};console.log("Menambahkan item dengan ID:",u.id),d("services",[...n.services,u])},I=t=>{if(typeof t=="object"&&t!==null){const h=t.next_number??t.nextNumber??1,a=t.padding??4,c=t.prefix??"",i=String(h||1).padStart(a,"0");return`${c}${i}`}const u=typeof t=="object"&&t!==null?t.nextNumber:t;return`INV/${String(u||1).padStart(4,"0")}`},{data:n,setData:d,post:G,processing:Q}=V({document_type:"INVOICE",client_type:null,date:"",number:I(F),company_id:null,company_name:null,address:"",contact_person:"",position:"",email:"",phone:"",quotation_id:"",payment_type:"",payment_percentage:0,payment_terms:"",note:"",services:[],ppn:0,pph:0,down_payment:0,sub_total:0,tax_amount_ppn:0,tax_amount_pph:0,total:0});C.useEffect(()=>{const t=n.services.reduce((s,r)=>s+Number(r.price||0),0),u=Number(n.ppn||0),g=Number(n.pph||0),h=Number(n.payment_percentage||0),a=t*u,c=t*g,i=t*h,b=t+a-c;(n.sub_total!==t||n.total!==b||n.tax_amount_ppn!==a||n.tax_amount_pph!==c||n.down_payment!==i)&&d(s=>({...s,sub_total:t,tax_amount_ppn:a,tax_amount_pph:c,down_payment:i,total:b}))},[n.services,n.ppn,n.pph,n.payment_percentage]);const O=async()=>{if(n.services.length===0){alert("Peringatan: Anda harus menambahkan setidaknya satu jasa/layanan sebelum menyimpan.");return}if(!n.company_id){alert("Pilih client");return}try{console.log("=== START SAVE INVOICE ==="),console.log("Current data:",n);const t=document.getElementById("quotation-pdf");if(!t)throw new Error("Element quotation-pdf not found");console.log("Generating PDF...");const u={margin:0,filename:`${n.number}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}},g=await L().set(u).from(t).output("blob");console.log("PDF generated, size:",g.size);const h=new FormData;console.log("Building FormData..."),Object.keys(n).forEach(a=>{if(a==="services"){const c=Array.isArray(n.services)?n.services:[];h.append("services",JSON.stringify(c)),console.log("Services:",c)}else n[a]!==null&&n[a]!==void 0&&h.append(a,n[a])}),h.append("pdf_file",g,`${n.number}.pdf`),console.log("FormData entries:");for(let a of h.entries())a[0]!=="pdf_file"&&console.log(a[0]+":",a[1]);console.log("Posting to server..."),D.post(route("invoice.store"),h,{forceFormData:!0,onSuccess:a=>{console.log("Success response:",a),A.success("Berhasil disimpan!",{style:{border:"1px solid #4ade80",padding:"16px",color:"#166534"},iconTheme:{primary:"#4ade80",secondary:"#FFFAEE"}})},onError:a=>{console.error("=== ERROR FROM SERVER ==="),console.error("Errors object:",a),console.error("Error keys:",Object.keys(a)),Object.keys(a).forEach(i=>{console.error(`${i}:`,a[i]),A.error(`${i}: ${a[i]}`,{duration:5e3})});const c=Object.entries(a).map(([i,b])=>`${i}: ${b}`).join(`
`);alert(`Error:
`+c)},onFinish:()=>{console.log("Request finished")}})}catch(t){console.error("=== CATCH ERROR ==="),console.error("Error message:",t.message),console.error("Error stack:",t.stack),console.error("Full error:",t),alert("Error: "+t.message)}},$=()=>{D.get("/invoice")},y=t=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",maximumFractionDigits:0}).format(t),{props:j}=q();return j.app_config?.doc_logo_path&&`${j.app_config.doc_logo_path}`,e.jsxs(e.Fragment,{children:[T&&e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[9999]",children:e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-2xl w-[400px] border border-gray-200",children:[e.jsx("h3",{className:"font-black text-gray-800 mb-4 uppercase tracking-tight text-sm",children:"Add New Service"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] font-bold uppercase text-gray-400",children:"Service Name"}),e.jsx("input",{className:"w-full border-gray-300 rounded-lg p-2 text-sm",placeholder:"Sertifikasi Alat",value:f.name,onChange:t=>w({...f,name:t.target.value})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] font-bold uppercase text-gray-400",children:"Qualification"}),e.jsx("input",{className:"w-full border-gray-300 rounded-lg p-2 text-sm",placeholder:"Kualifikasi Kecil, BG001, BG002, BG003",value:f.processing,onChange:t=>w({...f,processing:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] font-bold uppercase text-gray-400",children:"Price"}),e.jsx("input",{type:"number",className:"w-full border-gray-300 rounded-lg p-2 text-sm",placeholder:"0",value:f.price,onChange:t=>w({...f,price:t.target.value})})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 mt-8",children:[e.jsx("button",{onClick:()=>k(!1),className:"px-4 py-2 text-sm font-bold text-gray-400",children:"CANCEL"}),e.jsx("button",{onClick:()=>{if(!f.name||!f.price)return alert("Lengkapi data!");S(f),k(!1),w({name:"",processing:"",price:""})},className:"bg-[#2d6a4f] text-white px-6 py-2 rounded-lg font-bold text-sm shadow-lg",children:"ADD ITEM"})]})]})}),e.jsx(X,{position:"top-right"}),e.jsx(M,{title:"Invoice Builder",data:n,setData:d,onSave:O,onBack:$,renderEditor:({updateField:t})=>{const u=!n.client_type,g=(s,r,p,o)=>{const l=(s||[]).reduce((P,B)=>P+Number(B.price||0),0),m=l*r,x=l*p,N=l*o,E=l+m-x;t("sub_total",l),t("tax_amount_ppn",m),t("tax_amount_pph",x),t("down_payment",N),t("total",E),d(P=>({...P,sub_total:l,tax_amount_ppn:m,tax_amount_pph:x,down_payment:N,total:E,services:s}))},h=s=>{const r=n.client_type==="Client",o=(r?v:_).find(l=>String(l.id)===String(s));if(o){const l=r?o.lead:o,m={company_id:o.id,lead_id:r?o.lead_id:o.id,company_name:r?o.lead?.company_name||o.client_code:o.company_name,address:l?.address||"",contact_person_id:"",contact_person:"",email:"",phone:"",position:""};Object.entries(m).forEach(([x,N])=>t(x,N)),d(x=>({...x,...m}))}},a=n.client_type==="Client"?v||[]:_||[],c=s=>{const r=n.client_type==="Client",o=(r?v:_).find(l=>String(l.id)===String(n.company_id));if(o){let l=null;if(r?l=o.contact_persons?.find(m=>String(m.id)===String(s)):l=o,l){const m={contact_person_id:s,contact_person:r?l.lead?.contact_person||o.lead?.contact_person||"---":o.contact_person||"",email:r?l.lead?.email||o.lead?.email||"":l.email||"",phone:r?l.lead?.phone||o.lead?.phone||"":l.phone||"",position:r?l.position||"":o.job_title||o.position||""};console.log("Data yang dikirim ke builder:",m),Object.entries(m).forEach(([x,N])=>{typeof t=="function"&&t(x,N)}),d(x=>({...x,...m}))}}},i=s=>{let r=0;s&&s!=="0"&&(r=Number(s)),t("ppn",r),d(p=>({...p,ppn:r})),g(n.services,r,n.pph,n.payment_percentage)},b=s=>{let r=0;s&&s!=="0"&&(r=Number(s)),t("pph",r),d(p=>({...p,pph:r})),g(n.services,n.ppn,r,n.payment_percentage)};return e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:["Date",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsx("input",{type:"date",className:"w-full border-gray-300 rounded text-sm",value:n.date||"",onChange:s=>{t("date",s.target.value),d("date",s.target.value)}})]}),e.jsx("div",{className:"flex bg-gray-100 p-1 rounded-xl",children:["Client","Lead"].map(s=>{const r=n.client_type===s;return e.jsx("button",{type:"button",onClick:p=>{p.preventDefault();const o=s;t("client_type",o),d("client_type",o),d(l=>({...l,client_type:o,company_id:null,company_name:null,contact_person_id:null})),console.log("State updated to:",o)},className:`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${r?"bg-[#065f46] text-white shadow-md":"text-gray-400"}`,children:s.toUpperCase()},s)})}),e.jsxs("div",{className:u?"opacity-40 pointer-events-none":"",children:[e.jsxs("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:["Select Company",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsxs("select",{className:"w-full border-gray-300 rounded text-sm",value:n.company_id||"",onChange:s=>h(s.target.value),children:[e.jsxs("option",{value:"",children:["-- Choose ",n.client_type," --"]}),a.map(s=>e.jsx("option",{value:s.id,children:n.client_type==="Client"?s.lead?.company_name||s.client_code:s.company_name},s.id))]})]}),e.jsxs("div",{className:`space-y-1 ${n.company_name?"":"opacity-40"}`,children:[e.jsxs("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:["Select Contact Person",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsxs("select",{className:"w-full border-gray-300 rounded text-sm",value:n.contact_person_id||"",onChange:s=>c(s.target.value),children:[e.jsx("option",{value:"",children:"-- Choose Person --"}),(()=>{const s=n.client_type==="Client",p=(s?v:_).find(l=>String(l.id)===String(n.company_id));if(!p)return null;let o=p.contact_persons||[];return o.length===0&&!s&&(o=[{id:p.id}]),o.map(l=>{const m=s?p.lead?.contact_person||"No Name":p.contact_person||"No Name",x=s&&l.position?` (${l.position})`:"";return e.jsxs("option",{value:l.id,children:[m,x]},l.id)})})()]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Quotation - Accepted"}),e.jsxs("select",{className:"w-full border-gray-300 rounded text-sm",value:n.quotation_id||"",onChange:s=>{t("quotation_id",s.target.value),d("quotation_id",s.target.value)},children:[e.jsx("option",{value:"",children:"-- Choose Quotation --"}),R.map(s=>e.jsxs("option",{value:s.id,children:[s.no," - ",s.company_name||s.lead?.company_name]},s.id))]})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:["Payment Type",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsxs("select",{className:"w-full border-gray-300 rounded text-sm",value:n.payment_type||"",onChange:s=>{t("payment_type",s.target.value),d("payment_type",s.target.value)},children:[e.jsx("option",{value:"",children:"-- Choose Payment --"}),(j.paymentTypes||[]).map(s=>e.jsx("option",{value:s.name,children:s.name},s.id))]})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Payment Percentage (10 = 10%)"}),e.jsx("input",{type:"number",step:"1",min:"0",max:"100",className:"w-full border-gray-300 rounded text-sm font-bold",value:n.payment_percentage?n.payment_percentage*100:"",onChange:s=>{const r=s.target.value,p=r===""?"":Number(r),o=p===""?"":Number(p)/100;t("payment_percentage",o),d("payment_percentage",o),g(n.services,n.ppn,n.pph,o)}})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"PPN"}),e.jsxs("select",{className:"w-full border-gray-300 rounded text-sm",value:n.ppn||0,onChange:s=>i(s.target.value),children:[e.jsx("option",{value:"0",children:"-- No PPN --"}),(j.ppn||[]).map(s=>e.jsx("option",{value:s.rate,children:s.name},s.id))]})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"PPh"}),e.jsxs("select",{className:"w-full border-gray-300 rounded text-sm",value:n.pph||0,onChange:s=>b(s.target.value),children:[e.jsx("option",{value:"0",children:"-- No PPh --"}),(j.pph||[]).map(s=>e.jsx("option",{value:s.rate,children:s.name},s.id))]})]}),e.jsxs("div",{className:"flex flex-col justify-start",children:[e.jsxs("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:["Payment Terms",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsx("textarea",{rows:"3",className:"w-full border-gray-300 rounded text-sm font-bold",value:n.payment_terms||"",onChange:s=>{const r=s.target.value;t("payment_terms",r),d("payment_terms",r)}})]}),e.jsxs("div",{className:"flex flex-col justify-start",children:[e.jsxs("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:["Note",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsx("textarea",{rows:"3",className:"w-full border-gray-300 rounded text-sm font-bold",value:n.note||"",onChange:s=>{const r=s.target.value;t("note",r),d("note",r)}})]})]})]})},renderPreview:({data:t,addItem:u,removeItem:g,updateField:h})=>(S||setBuilderAddItem(()=>u),C.useEffect(()=>{const a=t.services.reduce((l,m)=>l+Number(m.price||0),0),c=Number(t.ppn)||0,i=Number(t.pph)||0,b=Number(t.payment_percentage||0),s=a*c,r=a*i,p=a*b,o=a+s-r;(t.sub_total!==a||t.total!==o||t.tax_amount_ppn!==s||t.tax_amount_pph!==r||t.down_payment!==p)&&d(l=>({...l,sub_total:a,tax_amount_ppn:s,tax_amount_pph:r,down_payment:p,total:o}))},[t.services,t.ppn,t.pph,t.payment_percentage]),e.jsxs("div",{className:"p-2 text-[12px]",children:[e.jsxs("div",{className:"flex justify-between pb-4 mb-6",children:[e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Number"}),e.jsx("p",{className:"font-bold",children:t.number||"INV-XXXXX"})]}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Date"}),e.jsx("p",{className:"font-bold",children:t.date||"Date Not Set"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-8 mb-8",children:[e.jsx("div",{className:"border border-black p-5 rounded-sm",children:e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"To:"}),e.jsx("p",{className:"font-bold text-emerald-800",children:t.contact_person||"---"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Email:"}),e.jsx("p",{className:"text-black",children:t.email})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Handphone:"}),e.jsx("p",{className:"text-black",children:t.phone})]})]})}),e.jsx("div",{className:"border border-black p-5 rounded-sm",children:e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Company:"}),e.jsx("p",{className:"font-black",children:t.company_name||"---"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Address:"}),e.jsx("p",{className:"text-black leading-tight",children:t.address||"No address provided."})]})]})})]}),e.jsx("p",{className:"text-[15px] font-bold text-black mb-2",children:"Services"}),e.jsxs("table",{className:"w-full border-collapse border border-black",children:[e.jsx("thead",{className:"bg-gray-50 uppercase text-[10px] font-black border-b border-black",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 text-center w-8 border border-black",children:"No"}),e.jsx("th",{className:"p-2 text-left border border-black",children:"Description"}),e.jsx("th",{className:"p-2 text-center w-24 border border-black",children:"Qualification"}),e.jsx("th",{className:"p-2 text-right w-32",children:"Price"}),e.jsx("th",{"data-html2canvas-ignore":"true",className:"print:hidden p-2 w-10"})]})}),e.jsx("tbody",{children:t.services.map((a,c)=>e.jsxs("tr",{className:"border-b border-gray-100 relative group",children:[e.jsx("td",{className:"p-2 text-center font-bold text-gray-400 border border-black",children:t.services.indexOf(a)+1}),e.jsx("td",{className:"p-2 font-bold uppercase border border-black",children:a.name}),e.jsx("td",{className:"p-2 text-center border border-black",children:a.processing}),e.jsx("td",{className:"p-2 text-right font-black border-b border-black",children:y(a.price)}),e.jsx("td",{className:"print:hidden p-2 text-center border-b border-black",children:e.jsx("button",{type:"button","data-html2canvas-ignore":"true",onClick:()=>{console.log("ID Item ini adalah:",a.id),g(a.id)},className:"text-red-400 hover:text-red-600 transition-colors",children:e.jsx(z,{size:14})})})]},a.id||c))})]}),e.jsx("div",{"data-html2canvas-ignore":"true",className:"mt-4 flex justify-start print:hidden",children:e.jsx("button",{"data-html2canvas-ignore":"true",onClick:()=>k(!0),className:"flex items-center gap-2 bg-[#065f46] text-white px-4 py-2 rounded-sm text-[10px] font-bold tracking-widest hover:scale-105 transition-all shadow-lg",children:"ADD SERVICE"})}),e.jsxs("div",{className:"mt-10 flex justify-between",children:[e.jsxs("div",{className:"w-1/2",children:[e.jsxs("div",{className:"h-[6rem] mb-5",children:[e.jsx("p",{className:"text-[15px] font-black font-bold mb-1",children:"Payment Terms"}),e.jsx("p",{className:"text-red-600 text-[11px] font-medium leading-tight whitespace-pre-wrap",children:t.payment_terms})]}),e.jsxs("div",{className:"h-[3rem] mb-20",children:[e.jsx("p",{className:"text-[15px] font-black font-bold mb-1",children:"Note"}),e.jsx("p",{className:"text-red-600 text-[11px] font-medium leading-tight whitespace-pre-wrap",children:t.note})]})]}),e.jsxs("div",{className:"w-1/3 space-y-1 font-bold",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:y(t.sub_total||0)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["Down Payment ",t.payment_percentage?`${(t.payment_percentage*100).toFixed(0)}%`:""]}),e.jsx("span",{children:y(t.down_payment||0)})]}),e.jsxs("div",{className:"flex justify-between text-red-600",children:[e.jsxs("span",{children:["VAT (PPN) ",(()=>{const a=j.ppn||[],c=Number(t.ppn||0),i=a.find(b=>Number(b.rate)===c);return i?i.name:c?`${(c*100).toFixed(0)}%`:""})()]}),e.jsx("span",{children:y(t.tax_amount_ppn||0)})]}),e.jsxs("div",{className:"flex justify-between text-red-600 border-b border-black pb-1",children:[e.jsxs("span",{children:["VAT (PPh) ",(()=>{const a=j.pph||[],c=Number(t.pph||0),i=a.find(b=>Number(b.rate)===c);return i?i.name:c?`${(c*100).toFixed(0)}%`:""})()]}),e.jsx("span",{children:y(t.tax_amount_pph||0)})]}),e.jsxs("div",{className:"flex justify-between text-sm font-black pt-1",children:[e.jsx("span",{children:"TOTAL"}),e.jsx("span",{children:y(t.total||0)})]}),e.jsx("p",{className:"text-[17px] uppercase font-black pt-[0.9rem] pb-[5.2rem]",children:t.company_name||"---"}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-[15px] uppercase font-black pt-[0.9rem]",children:t.contact_person||"---"}),e.jsx("p",{className:"text-[15px] text-gray-400",children:t.position||"---"})]})]})]})]}))})]})}export{U as default};
