import{r as P,u as $,a as L,j as e,c as T}from"./app--V8YQuQk.js";import{B as M,h as V}from"./html2pdf-CvayzF7q.js";import{F as X,n as q}from"./index-DvGSOaWZ.js";import{u as G}from"./useTranslation-DGCn9e9S.js";import{T as Q}from"./trash-2-D2TdDDoH.js";import"./createLucideIcon-D7A-7CJ7.js";function ee({leads:w=[],companies:C=[],quotations:F=[],invoice:o}){const{t:j}=G(),[I,D]=P.useState(!1),[g,k]=P.useState({name:"",processing:"",price:""}),S=s=>{const b={...s,id:Date.now()+Math.random(),price:Number(s.price)||0};console.log("Menambahkan item dengan ID:",b.id),d("services",[...a.services,b])},{data:a,setData:d,put:z,processing:K}=$({document_type:"INVOICE",client_type:o.is_client?"Client":"Lead",date:o.date||"",number:o.invoice_number||"",company_id:o.company_id||null,contact_person_id:o.contact_person_id||null,company_name:o.company_name||"",address:o.address||"",contact_person:o.contact_person||"",position:o.position||"",email:o.email||"",phone:o.phone||"",quotation_id:o.quotation_id||"",payment_type:o.payment_type||"",payment_percentage:o.payment_percentage||0,payment_terms:o.payment_terms||"",note:o.note||"",services:o.invoice_items||[],ppn:o.ppn||0,pph:o.pph||0,down_payment:o.down_payment||0,sub_total:o.sub_total||0,tax_amount_ppn:o.tax_amount_ppn||0,tax_amount_pph:o.tax_amount_pph||0,total:o.total||0});P.useEffect(()=>{const s=a.services.reduce((t,n)=>t+Number(n.price||0),0),b=Number(a.ppn||0),y=Number(a.pph||0),h=Number(a.payment_percentage||0),c=s*b,p=s*y,u=s*h,f=s+c-p;(a.sub_total!==s||a.total!==f||a.tax_amount_ppn!==c||a.tax_amount_pph!==p||a.down_payment!==u)&&d(t=>({...t,sub_total:s,tax_amount_ppn:c,tax_amount_pph:p,down_payment:u,total:f}))},[a.services,a.ppn,a.pph,a.payment_percentage]);const R=async()=>{if(a.services.length===0){alert("Peringatan: Anda harus menambahkan setidaknya satu jasa/layanan sebelum menyimpan.");return}if(!a.company_id){alert("Pilih client");return}try{const s=document.getElementById("quotation-pdf"),b={margin:0,filename:`${a.number}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}},y=await V().set(b).from(s).output("blob"),h=new FormData;Object.keys(a).forEach(c=>{if(c==="services"){const p=Array.isArray(a.services)?a.services:[];h.append("services",JSON.stringify(p))}else a[c]!==null&&a[c]!==void 0&&h.append(c,a[c])}),h.append("pdf_file",y,`${a.number}.pdf`),h.append("_method","PUT"),T.post(route("invoice.update",o.id),h,{forceFormData:!0,onSuccess:()=>{q.success("Berhasil diupdate!",{style:{border:"1px solid #4ade80",padding:"16px",color:"#166534"},iconTheme:{primary:"#4ade80",secondary:"#FFFAEE"}})},onError:c=>{console.error("Penyebab Gagal Update",c);for(let p of h.entries())console.log(p[0]+": "+p[1])}})}catch(s){console.error("Error:",s)}},B=()=>{T.get("/invoice")},N=s=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",maximumFractionDigits:0}).format(s),{props:_}=L();return _.app_config?.doc_logo_path&&`${_.app_config.doc_logo_path}`,e.jsxs(e.Fragment,{children:[I&&e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[9999]",children:e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-2xl w-[400px] border border-gray-200",children:[e.jsx("h3",{className:"font-black text-gray-800 mb-4 uppercase tracking-tight text-sm",children:j("invoices.add_service")||"Add New Service"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] font-bold uppercase text-gray-400",children:j("invoices.service_name")||"Service Name"}),e.jsx("input",{className:"w-full border-gray-300 rounded-lg p-2 text-sm",placeholder:"Sertifikasi Alat",value:g.name,onChange:s=>k({...g,name:s.target.value})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] font-bold uppercase text-gray-400",children:j("invoices.qualification")||"Qualification"}),e.jsx("input",{className:"w-full border-gray-300 rounded-lg p-2 text-sm",placeholder:"Kualifikasi Kecil, BG001, BG002, BG003",value:g.processing,onChange:s=>k({...g,processing:s.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] font-bold uppercase text-gray-400",children:j("invoices.price")||"Price"}),e.jsx("input",{type:"number",className:"w-full border-gray-300 rounded-lg p-2 text-sm",placeholder:"0",value:g.price,onChange:s=>k({...g,price:s.target.value})})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 mt-8",children:[e.jsx("button",{onClick:()=>D(!1),className:"px-4 py-2 text-sm font-bold text-gray-400",children:j("invoices.cancel")||"CANCEL"}),e.jsx("button",{onClick:()=>{if(!g.name||!g.price)return alert("Lengkapi data!");S(g),D(!1),k({name:"",processing:"",price:""})},className:"bg-[#2d6a4f] text-white px-6 py-2 rounded-lg font-bold text-sm shadow-lg",children:j("invoices.add_item")||"ADD ITEM"})]})]})}),e.jsx(X,{position:"top-right"}),e.jsx(M,{title:j("invoices.builder_title")||"Edit Invoice",data:a,setData:d,onSave:R,onBack:B,renderEditor:({updateField:s})=>{const b=!a.client_type,y=(t,n,i,l)=>{const r=(t||[]).reduce((A,O)=>A+Number(O.price||0),0),m=r*n,x=r*i,v=r*l,E=r+m-x;s("sub_total",r),s("tax_amount_ppn",m),s("tax_amount_pph",x),s("down_payment",v),s("total",E),d(A=>({...A,sub_total:r,tax_amount_ppn:m,tax_amount_pph:x,down_payment:v,total:E,services:t}))},h=t=>{const n=a.client_type==="Client",l=(n?C:w).find(r=>String(r.id)===String(t));if(l){const r=n?l.lead:l,m={company_id:l.id,lead_id:n?l.lead_id:l.id,company_name:n?l.lead?.company_name||l.client_code:l.company_name,address:r?.address||"",contact_person_id:"",contact_person:"",email:"",phone:"",position:""};Object.entries(m).forEach(([x,v])=>s(x,v)),d(x=>({...x,...m}))}},c=a.client_type==="Client"?C||[]:w||[],p=t=>{const n=a.client_type==="Client",l=(n?C:w).find(r=>String(r.id)===String(a.company_id));if(l){let r=null;if(n?r=l.contact_persons?.find(m=>String(m.id)===String(t)):r=l,r){const m={contact_person_id:t,contact_person:n?r.lead?.contact_person||l.lead?.contact_person||"---":l.contact_person||"",email:n?r.lead?.email||l.lead?.email||"":r.email||"",phone:n?r.lead?.phone||l.lead?.phone||"":r.phone||"",position:n?r.position||"":l.job_title||l.position||""};console.log("Data yang dikirim ke builder:",m),Object.entries(m).forEach(([x,v])=>{typeof s=="function"&&s(x,v)}),d(x=>({...x,...m}))}}},u=t=>{let n=0;t&&t!=="0"&&(n=Number(t)),s("ppn",n),d(i=>({...i,ppn:n})),y(a.services,n,a.pph,a.payment_percentage)},f=t=>{let n=0;t&&t!=="0"&&(n=Number(t)),s("pph",n),d(i=>({...i,pph:n})),y(a.services,a.ppn,n,a.payment_percentage)};return e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:["Date",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsx("input",{type:"date",className:"w-full border-gray-300 rounded text-sm",value:a.date||"",onChange:t=>{s("date",t.target.value),d("date",t.target.value)}})]}),e.jsx("div",{className:"flex bg-gray-100 p-1 rounded-xl",children:["Client","Lead"].map(t=>{const n=a.client_type===t;return e.jsx("button",{type:"button",onClick:i=>{i.preventDefault();const l=t;s("client_type",l),d("client_type",l),d(r=>({...r,client_type:l,company_id:null,company_name:null,contact_person_id:null})),console.log("State updated to:",l)},className:`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${n?"bg-[#065f46] text-white shadow-md":"text-gray-400"}`,children:t.toUpperCase()},t)})}),e.jsxs("div",{className:b?"opacity-40 pointer-events-none":"",children:[e.jsxs("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:["Select Company",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsxs("select",{className:"w-full border-gray-300 rounded text-sm",value:a.company_id||"",onChange:t=>h(t.target.value),children:[e.jsxs("option",{value:"",children:["-- Choose ",a.client_type," --"]}),c.map(t=>e.jsx("option",{value:t.id,children:a.client_type==="Client"?t.lead?.company_name||t.client_code:t.company_name},t.id))]})]}),e.jsxs("div",{className:`space-y-1 ${a.company_name?"":"opacity-40"}`,children:[e.jsxs("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:["Select Contact Person",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsxs("select",{className:"w-full border-gray-300 rounded text-sm",value:a.contact_person_id||"",onChange:t=>p(t.target.value),children:[e.jsx("option",{value:"",children:"-- Choose Person --"}),(()=>{const t=a.client_type==="Client",i=(t?C:w).find(r=>String(r.id)===String(a.company_id));if(!i)return null;let l=i.contact_persons||[];return l.length===0&&!t&&(l=[{id:i.id}]),l.map(r=>{const m=t?i.lead?.contact_person||"No Name":i.contact_person||"No Name",x=t&&r.position?` (${r.position})`:"";return e.jsxs("option",{value:r.id,children:[m,x]},r.id)})})()]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Quotation - Accepted"}),e.jsxs("select",{className:"w-full border-gray-300 rounded text-sm",value:a.quotation_id||"",onChange:t=>{s("quotation_id",t.target.value),d("quotation_id",t.target.value)},children:[e.jsx("option",{value:"",children:"-- Choose Quotation --"}),F.map(t=>e.jsxs("option",{value:t.id,children:[t.no," - ",t.company_name||t.lead?.company_name]},t.id))]})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:["Payment Type",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsxs("select",{className:"w-full border-gray-300 rounded text-sm",value:a.payment_type||"",onChange:t=>{s("payment_type",t.target.value),d("payment_type",t.target.value)},children:[e.jsx("option",{value:"",children:"-- Choose Payment --"}),(_.paymentTypes||[]).map(t=>e.jsx("option",{value:t.name,children:t.name},t.id))]})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Payment Percentage (10 = 10%)"}),e.jsx("input",{type:"number",step:"1",min:"0",max:"100",className:"w-full border-gray-300 rounded text-sm font-bold",value:a.payment_percentage?a.payment_percentage*100:"",onChange:t=>{const n=t.target.value,i=n===""?"":Number(n),l=i===""?"":Number(i)/100;s("payment_percentage",l),d("payment_percentage",l),y(a.services,a.ppn,a.pph,l)}})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"PPN"}),e.jsxs("select",{className:"w-full border-gray-300 rounded text-sm",value:a.ppn||0,onChange:t=>u(t.target.value),children:[e.jsx("option",{value:"0",children:"-- No PPN --"}),(_.ppn||[]).map(t=>e.jsx("option",{value:t.rate,children:t.name},t.id))]})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"PPh"}),e.jsxs("select",{className:"w-full border-gray-300 rounded text-sm",value:a.pph||0,onChange:t=>f(t.target.value),children:[e.jsx("option",{value:"0",children:"-- No PPh --"}),(_.pph||[]).map(t=>e.jsx("option",{value:t.rate,children:t.name},t.id))]})]}),e.jsxs("div",{className:"flex flex-col justify-start",children:[e.jsxs("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:["Payment Terms",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsx("textarea",{rows:"3",className:"w-full border-gray-300 rounded text-sm font-bold",value:a.payment_terms||"",onChange:t=>{const n=t.target.value;s("payment_terms",n),d("payment_terms",n)}})]}),e.jsxs("div",{className:"flex flex-col justify-start",children:[e.jsxs("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:["Note",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsx("textarea",{rows:"3",className:"w-full border-gray-300 rounded text-sm font-bold",value:a.note||"",onChange:t=>{const n=t.target.value;s("note",n),d("note",n)}})]})]})]})},renderPreview:({data:s,addItem:b,removeItem:y,updateField:h})=>(S||setBuilderAddItem(()=>b),P.useEffect(()=>{const c=s.services.reduce((r,m)=>r+Number(m.price||0),0),p=Number(s.ppn)||0,u=Number(s.pph)||0,f=Number(s.payment_percentage||0),t=c*p,n=c*u,i=c*f,l=c+t-n;(s.sub_total!==c||s.total!==l||s.tax_amount_ppn!==t||s.tax_amount_pph!==n||s.down_payment!==i)&&d(r=>({...r,sub_total:c,tax_amount_ppn:t,tax_amount_pph:n,down_payment:i,total:l}))},[s.services,s.ppn,s.pph,s.payment_percentage]),e.jsxs("div",{className:"p-2 text-[12px]",children:[e.jsxs("div",{className:"flex justify-between pb-4 mb-6",children:[e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Number"}),e.jsx("p",{className:"font-bold",children:s.number||"INV-XXXXX"})]}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Date"}),e.jsx("p",{className:"font-bold",children:s.date||"Date Not Set"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-8 mb-8",children:[e.jsx("div",{className:"border border-black p-5 rounded-sm",children:e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"To:"}),e.jsx("p",{className:"font-bold text-emerald-800",children:s.contact_person||"---"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Email:"}),e.jsx("p",{className:"text-black",children:s.email})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Handphone:"}),e.jsx("p",{className:"text-black",children:s.phone})]})]})}),e.jsx("div",{className:"border border-black p-5 rounded-sm",children:e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Company:"}),e.jsx("p",{className:"font-black",children:s.company_name||"---"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Address:"}),e.jsx("p",{className:"text-black leading-tight",children:s.address||"No address provided."})]})]})})]}),e.jsx("p",{className:"text-[15px] font-bold text-black mb-2",children:"Services"}),e.jsxs("table",{className:"w-full border-collapse border border-black",children:[e.jsx("thead",{className:"bg-gray-50 uppercase text-[10px] font-black border-b border-black",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 text-center w-8 border border-black",children:"No"}),e.jsx("th",{className:"p-2 text-left border border-black",children:"Description"}),e.jsx("th",{className:"p-2 text-center w-24 border border-black",children:"Qualification"}),e.jsx("th",{className:"p-2 text-right w-32",children:"Price"}),e.jsx("th",{"data-html2canvas-ignore":"true",className:"print:hidden p-2 w-10"})]})}),e.jsx("tbody",{children:s.services.map((c,p)=>e.jsxs("tr",{className:"border-b border-gray-100 relative group",children:[e.jsx("td",{className:"p-2 text-center font-bold text-gray-400 border border-black",children:s.services.indexOf(c)+1}),e.jsx("td",{className:"p-2 font-bold uppercase border border-black",children:c.name}),e.jsx("td",{className:"p-2 text-center border border-black",children:c.processing}),e.jsx("td",{className:"p-2 text-right font-black border-b border-black",children:N(c.price)}),e.jsx("td",{className:"print:hidden p-2 text-center border-b border-black",children:e.jsx("button",{type:"button","data-html2canvas-ignore":"true",onClick:()=>{console.log("ID Item ini adalah:",c.id),y(c.id)},className:"text-red-400 hover:text-red-600 transition-colors",children:e.jsx(Q,{size:14})})})]},c.id||p))})]}),e.jsx("div",{"data-html2canvas-ignore":"true",className:"mt-4 flex justify-start print:hidden",children:e.jsx("button",{"data-html2canvas-ignore":"true",onClick:()=>D(!0),className:"flex items-center gap-2 bg-[#065f46] text-white px-4 py-2 rounded-sm text-[10px] font-bold tracking-widest hover:scale-105 transition-all shadow-lg",children:"ADD SERVICE"})}),e.jsxs("div",{className:"mt-10 flex justify-between",children:[e.jsxs("div",{className:"w-1/2",children:[e.jsxs("div",{className:"h-[6rem] mb-5",children:[e.jsx("p",{className:"text-[15px] font-black font-bold mb-1",children:"Payment Terms"}),e.jsx("p",{className:"text-red-600 text-[11px] font-medium leading-tight whitespace-pre-wrap",children:s.payment_terms})]}),e.jsxs("div",{className:"h-[3rem] mb-20",children:[e.jsx("p",{className:"text-[15px] font-black font-bold mb-1",children:"Note"}),e.jsx("p",{className:"text-red-600 text-[11px] font-medium leading-tight whitespace-pre-wrap",children:s.note})]})]}),e.jsxs("div",{className:"w-1/3 space-y-1 font-bold",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:N(s.sub_total||0)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{children:["Down Payment ",s.payment_percentage?`${(s.payment_percentage*100).toFixed(0)}%`:""]}),e.jsx("span",{children:N(s.down_payment||0)})]}),e.jsxs("div",{className:"flex justify-between text-red-600",children:[e.jsxs("span",{children:["VAT (PPN) ",(()=>{const c=_.ppn||[],p=Number(s.ppn||0),u=c.find(f=>Number(f.rate)===p);return u?u.name:p?`${(p*100).toFixed(0)}%`:""})()]}),e.jsx("span",{children:N(s.tax_amount_ppn||0)})]}),e.jsxs("div",{className:"flex justify-between text-red-600 border-b border-black pb-1",children:[e.jsxs("span",{children:["VAT (PPh) ",(()=>{const c=_.pph||[],p=Number(s.pph||0),u=c.find(f=>Number(f.rate)===p);return u?u.name:p?`${(p*100).toFixed(0)}%`:""})()]}),e.jsx("span",{children:N(s.tax_amount_pph||0)})]}),e.jsxs("div",{className:"flex justify-between text-sm font-black pt-1",children:[e.jsx("span",{children:"TOTAL"}),e.jsx("span",{children:N(s.total||0)})]}),e.jsx("p",{className:"text-[17px] uppercase font-black pt-[0.9rem] pb-[5.2rem]",children:s.company_name||"---"}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-[15px] uppercase font-black pt-[0.9rem]",children:s.contact_person||"---"}),e.jsx("p",{className:"text-[15px] text-gray-400",children:s.position||"---"})]})]})]})]}))})]})}export{ee as default};
