import{r as g,c as T,j as p}from"./app-BTbkV42h.js";import{_,t as q}from"./index-MEVmEr_H.js";function M({id:b,template:r}){const[w,d]=g.useState(!1),S=g.useRef(null),x=g.useRef([]);g.useEffect(()=>{d(!0);const e=_.init({container:"#gjs",height:"100vh",fromElement:!1,storageManager:!1,allowScripts:1,blockManager:{expandState:!1},canvas:{styles:["/templates/css/icons/iconfont.css","/templates/css/plugins/bootstrap.min.css","/templates/css/font-awesome.min.css","http://fonts.googleapis.com/css?family=Lato:300,400,700,900,300italic,400italic,700italic,900italic","/templates/css/plugins/magnific-popup.css","/templates/css/plugins/owl.carousel.css","/templates/css/plugins/loaders.css","/templates/css/plugins/animate.css","/templates/css/style.css","/templates/css/responsive.css"],scripts:["/templates/js/plugins/jquery1.11.2.min.js","/templates/js/plugins/bootstrap.min.js","/templates/js/plugins/jquery.easing.1.3.min.js","/templates/js/plugins/jquery.countTo.js","/templates/js/plugins/jquery.formchimp.min.js","/templates/js/plugins/jquery.jCounter-0.1.4.js","/templates/js/plugins/jquery.magnific-popup.min.js","/templates/js/plugins/jquery.vide.min.js","/templates/js/plugins/owl.carousel.min.js","/templates/js/plugins/twitterFetcher_min.js","/templates/js/plugins/wow.min.js","/templates/js/custom.js"]}});e.Panels.addButton("options",[{id:"save-page",className:"fa fa-save",command:()=>{confirm("Apakah Anda yakin ingin menyimpan halaman ini?")&&C(e)},attributes:{title:"Save Page"}},{id:"go-back",className:"fa fa-arrow-left",command:()=>{confirm("Perubahan yang belum disimpan akan hilang. Kembali?")&&T.visit(document.referrer||route("proposal.index"))},attributes:{title:"Kembali"}}]),e.on("load",()=>{r&&(r.html_output&&e.setComponents(r.html_output),r.css_output&&e.setStyle(r.css_output));const s=e.Panels.getButton("views","open-blocks");s&&s.set("active",!0),e.BlockManager.getCategories().each(a=>{a.set("open",!1)})}),fetch("/api/proposal/templates").then(s=>s.json()).then(s=>{x.current=s,s.forEach((t,a)=>{e.BlockManager.add(`template-${a}`,{category:t.category||"Templates",media:`<img src="${t.preview}" style="width: 100%; height: auto; display: block;" />`,content:`<input type="hidden" data-template-category="${t.category||"Templates"}">${t.html}<style>${t.css}</style>`,attributes:{class:"gjs-block-section"}})})}).finally(()=>d(!1)),S.current=e},[]);const C=async e=>{const s=e.getHtml(),a=new DOMParser().parseFromString(s,"text/html"),u=[...new Set([...a.querySelectorAll("[data-template-category]")].map(i=>i.dataset.templateCategory))],o=e.getConfig().canvas,n=async i=>{try{const P=await(await fetch(i)).text();return j(P,a)}catch{return console.error("Gagal mengambil CSS:",i),""}},l=o.styles.map(i=>n(i)),c=await Promise.all(l),f=j(e.getCss(),a),v=c.join(`
`)+`
`+f,R=e.Canvas.getFrameEl().contentDocument.body,k=await q(R,{backgroundColor:"#ffffff",pixelRatio:2}),B=await new Promise(i=>{const m=new FileReader;m.onloadend=()=>i(m.result),m.readAsDataURL(k)}),h=await(await fetch("/proposal",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({id:b,html:s,css:v,categories:u,image:B})})).json();h.success&&(alert("Simpan Berhasil!"),window.location.href=h.redirect)};function j(e,s){if(!e)return"";const t=new CSSStyleSheet;try{t.replaceSync(e)}catch{return e}let a="";const u=t.cssRules;for(let o=0;o<u.length;o++){const n=u[o];if(n instanceof CSSMediaRule){let l="";for(let c=0;c<n.cssRules.length;c++){const f=n.cssRules[c];y(f.selectorText,s)&&(l+=f.cssText+`
`)}l&&(a+=`@media ${n.conditionText} {
${l}}
`)}else n.selectorText?y(n.selectorText,s)&&(a+=n.cssText+`
`):a+=n.cssText+`
`}return a}function y(e,s){if(!e)return!1;const t=e.split(":")[0].split(",")[0].trim();if(!t)return!0;try{return s.querySelector(t)!==null}catch{return!0}}return p.jsxs(p.Fragment,{children:[w&&p.jsx("div",{className:"fixed inset-0 bg-white/70 flex items-center justify-center z-50",children:p.jsx("span",{className:"animate-spin h-8 w-8 border-4 border-blue-500 border-t-transparent rounded-full"})}),p.jsx("div",{id:"gjs",className:"ps-2 pb-4"})]})}export{M as default};
