import{r as P,a as M,u as V,j as e,c as O}from"./app-Dyd-VK-i.js";import{B as X,h as q}from"./html2pdf-tV8gng31.js";import{F as G,n as Q}from"./index-BAWYnhaJ.js";import{u as z}from"./useTranslation-C1duoCZq.js";import{T as K}from"./trash-2-xd5U0av9.js";import"./createLucideIcon-CMta4jpe.js";function ne({leads:w=[],companies:C=[],quotations:I=[],invoice:c}){const{t:N}=z(),[R,F]=P.useState(!1),[_,k]=P.useState({name:"",processing:"",price:""}),{props:j}=M(),{auth:S,app_config:D}=j,T=t=>{const y={...t,id:Date.now()+Math.random(),price:Number(t.price)||0};console.log("Menambahkan item dengan ID:",y.id),x("services",[...a.services,y])},{data:a,setData:x,put:H,processing:J}=V({document_type:"INVOICE",client_type:c.is_client?"Client":"Lead",date:c.date||"",number:c.invoice_number||"",prepared_by_name:S?.user?.name||c.creator?.name||"",prepared_by_role:S?.user?.role_name||c.creator?.role?.name||"",my_company_name:D?.company_name||"",company_id:c.company_id||null,contact_person_id:c.contact_person_id||null,company_name:c.company_name||"",address:c.address||"",contact_person:c.contact_person||"",position:c.position||"",email:c.email||"",phone:c.phone||"",quotation_id:c.quotation_id||"",payment_type:c.payment_type||"",payment_percentage:c.payment_percentage||0,payment_terms:c.payment_terms||"",note:c.note||"",services:c.invoice_items||[],ppn:c.ppn||0,pph:c.pph||0,down_payment:c.down_payment||0,sub_total:c.sub_total||0,tax_amount_ppn:c.tax_amount_ppn||0,tax_amount_pph:c.tax_amount_pph||0,total:c.total||0});P.useEffect(()=>{const t=a.services.reduce((n,s)=>n+Number(s.price||0),0),y=Number(a.ppn||0),g=Number(a.pph||0),u=Number(a.payment_percentage||0),o=t*y,m=t*g,h=t*u,b=t+o-m;(a.sub_total!==t||a.total!==b||a.tax_amount_ppn!==o||a.tax_amount_pph!==m||a.down_payment!==h)&&x(n=>({...n,sub_total:t,tax_amount_ppn:o,tax_amount_pph:m,down_payment:h,total:b}))},[a.services,a.ppn,a.pph,a.payment_percentage]),P.useEffect(()=>{if(!a.company_id)return;const t=a.client_type==="Client",g=(t?C:w).find(o=>String(o.id)===String(a.company_id));if(!g)return;const u=t?g.lead:g;u&&x(o=>({...o,contact_person_id:u.id,contact_person:u.contact_person||u.name||"",email:u.email||"",phone:u.phone||"",position:u.position||""}))},[a.company_id,a.client_type]);const $=async()=>{if(a.services.length===0){alert("Peringatan: Anda harus menambahkan setidaknya satu jasa/layanan sebelum menyimpan.");return}if(!a.company_id){alert("Pilih client");return}try{const t=document.getElementById("quotation-pdf"),y={margin:0,filename:`${a.number}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}},g=await q().set(y).from(t).output("blob"),u=new FormData;Object.keys(a).forEach(o=>{if(o==="services"){const m=Array.isArray(a.services)?a.services:[];u.append("services",JSON.stringify(m))}else a[o]!==null&&a[o]!==void 0&&u.append(o,a[o])}),u.append("pdf_file",g,`${a.number}.pdf`),u.append("_method","PUT"),O.post(route("invoice.update",c.id),u,{forceFormData:!0,onSuccess:()=>{Q.success("Berhasil diupdate!",{style:{border:"1px solid #4ade80",padding:"16px",color:"#166534"},iconTheme:{primary:"#4ade80",secondary:"#FFFAEE"}})},onError:o=>{console.error("Penyebab Gagal Update",o);for(let m of u.entries())console.log(m[0]+": "+m[1])}})}catch(t){console.error("Error:",t)}},B=()=>{O.get("/invoice")},v=t=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",maximumFractionDigits:0}).format(t);return D?.doc_logo_path&&`${D.doc_logo_path}`,e.jsxs(e.Fragment,{children:[R&&e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[9999]",children:e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-2xl w-[400px] border border-gray-200",children:[e.jsx("h3",{className:"font-black text-gray-800 mb-4 uppercase tracking-tight text-sm",children:N("invoices.add_service")||"Add New Service"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] font-bold uppercase text-gray-400",children:N("invoices.service_name")||"Service Name"}),e.jsx("input",{className:"w-full border-gray-300 rounded-lg p-2 text-sm",placeholder:"Sertifikasi Alat",value:_.name,onChange:t=>k({..._,name:t.target.value})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] font-bold uppercase text-gray-400",children:N("invoices.qualification")||"Qualification"}),e.jsx("input",{className:"w-full border-gray-300 rounded-lg p-2 text-sm",placeholder:"Kualifikasi Kecil, BG001, BG002, BG003",value:_.processing,onChange:t=>k({..._,processing:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] font-bold uppercase text-gray-400",children:N("invoices.price")||"Price"}),e.jsx("input",{type:"number",className:"w-full border-gray-300 rounded-lg p-2 text-sm",placeholder:"0",value:_.price,onChange:t=>k({..._,price:t.target.value})})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 mt-8",children:[e.jsx("button",{onClick:()=>F(!1),className:"px-4 py-2 text-sm font-bold text-gray-400",children:N("invoices.cancel")||"CANCEL"}),e.jsx("button",{onClick:()=>{if(!_.name||!_.price)return alert("Lengkapi data!");T(_),F(!1),k({name:"",processing:"",price:""})},className:"bg-[#2d6a4f] text-white px-6 py-2 rounded-lg font-bold text-sm shadow-lg",children:N("invoices.add_item")||"ADD ITEM"})]})]})}),e.jsx(G,{position:"top-right"}),e.jsx(X,{title:N("invoices.builder_title")||"Edit Invoice",data:a,setData:x,onSave:$,onBack:B,renderEditor:({updateField:t})=>{const y=!a.client_type,g=(n,s,i,r)=>{const l=(n||[]).reduce((E,L)=>E+Number(L.price||0),0),d=l*s,p=l*i,f=l*r,A=l+d-p;t("sub_total",l),t("tax_amount_ppn",d),t("tax_amount_pph",p),t("down_payment",f),t("total",A),x(E=>({...E,sub_total:l,tax_amount_ppn:d,tax_amount_pph:p,down_payment:f,total:A,services:n}))},u=n=>{const s=a.client_type==="Client",r=(s?C:w).find(l=>String(l.id)===String(n));if(r){const l=s?r.lead:r;console.log("handleSelectionChange - selected:",r),console.log("handleSelectionChange - dataSource:",l);const d={company_id:r.id,lead_id:s?r.lead_id:r.id,company_name:s?r.lead?.company_name||r.client_code:r.company_name,address:l?.address||"",contact_person_id:l?.id||"",contact_person:l?.contact_person||l?.name||"",email:l?.email||"",phone:l?.phone||"",position:l?.position||""};console.log("handleSelectionChange - auto-fill contact from dataSource:",{contact_person_id:d.contact_person_id,contact_person:d.contact_person,email:d.email,phone:d.phone}),Object.entries(d).forEach(([p,f])=>t(p,f)),x(p=>({...p,...d}))}},o=a.client_type==="Client"?C||[]:w||[],m=n=>{const s=a.client_type==="Client",r=(s?C:w).find(l=>String(l.id)===String(a.company_id));if(r){const l=s?r.lead:r;console.log("handleContactChange - test:",l),console.log("handleContactChange - apaaj:",a.company_id,"contactId:",n),console.log("handleContactChange - apaaka:",r),console.log("handleContactChange - leadObj:",l);let d=null;if(l&&String(l.id)===String(n)&&(d=l,console.log("handleContactChange - personRow set from leadObj:",d)),!d&&r.contact_persons&&(d=r.contact_persons.find(p=>String(p.id)===String(n)),console.log("handleContactChange - personRow set from contact_persons:",d)),d){const p={contact_person_id:n,contact_person:d.contact_person||d.name||"",email:d.email||"",phone:d.phone||"",position:d.position||""};console.log("Data yang dikirim ke builder (lead-first):",p),Object.entries(p).forEach(([f,A])=>{typeof t=="function"&&t(f,A)}),x(f=>({...f,...p}))}}},h=n=>{let s=0;n&&n!=="0"&&(s=Number(n)),t("ppn",s),x(i=>({...i,ppn:s})),g(a.services,s,a.pph,a.payment_percentage)},b=n=>{let s=0;n&&n!=="0"&&(s=Number(n)),t("pph",s),x(i=>({...i,pph:s})),g(a.services,a.ppn,s,a.payment_percentage)};return e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:["Date",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsx("input",{type:"date",className:"w-full border-gray-300 rounded text-sm",value:a.date||"",onChange:n=>{t("date",n.target.value),x("date",n.target.value)}})]}),e.jsx("div",{className:"flex bg-gray-100 p-1 rounded-xl",children:["Client","Lead"].map(n=>{const s=a.client_type===n;return e.jsx("button",{type:"button",onClick:i=>{i.preventDefault();const r=n;t("client_type",r),x("client_type",r),x(l=>({...l,client_type:r,company_id:null,company_name:null,contact_person_id:null})),console.log("State updated to:",r)},className:`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${s?"bg-[#065f46] text-white shadow-md":"text-gray-400"}`,children:n.toUpperCase()},n)})}),e.jsxs("div",{className:y?"opacity-40 pointer-events-none":"",children:[e.jsxs("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:["Select Company",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsxs("select",{className:"w-full border-gray-300 rounded text-sm",value:a.company_id||"",onChange:n=>u(n.target.value),children:[e.jsxs("option",{value:"",children:["-- Choose ",a.client_type," --"]}),o.map(n=>e.jsx("option",{value:n.id,children:a.client_type==="Client"?n.lead?.company_name||n.client_code:n.company_name},n.id))]})]}),e.jsxs("div",{className:`space-y-1 ${a.company_name?"":"opacity-40"}`,children:[e.jsxs("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:["Select Contact Person",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsxs("select",{className:"w-full border-gray-300 rounded text-sm",value:a.contact_person_id||"",onChange:n=>m(n.target.value),children:[e.jsx("option",{value:"",children:"-- Choose Contact Person --"}),(()=>{const n=a.client_type==="Client",i=(n?C:w).find(p=>String(p.id)===String(a.company_id));if(!i)return null;console.log("Rendering contact options - selectedOrg:",i);const r=n?i.lead:i,l=[];return r&&l.push({id:r.id,label:r.contact_person||r.name||r.company_name||"No Name",position:r.position||""}),(i.contact_persons||[]).forEach(p=>{l.find(f=>String(f.id)===String(p.id))||l.push({id:p.id,label:p.contact_person||p.name||p.company_name||"No Name",position:p.position||""})}),console.log("Rendering contact options - options:",l),l.length===0?null:l.map(p=>e.jsxs("option",{value:p.id,children:[p.label,p.position?` (${p.position})`:""]},p.id))})()]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Quotation - Accepted"}),e.jsxs("select",{className:"w-full border-gray-300 rounded text-sm",value:a.quotation_id||"",onChange:n=>{t("quotation_id",n.target.value),x("quotation_id",n.target.value)},children:[e.jsx("option",{value:"",children:"-- Choose Quotation --"}),I.map(n=>e.jsxs("option",{value:n.id,children:[n.no," - ",n.company_name||n.lead?.company_name]},n.id))]})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:["Payment Type",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsxs("select",{className:"w-full border-gray-300 rounded text-sm",value:a.payment_type||"",onChange:n=>{const s=n.target.value;t("payment_type",s),x("payment_type",s);const i=(j.paymentTypes||[]).find(l=>l.name===s||l.slug===s);console.log("Selected payment type:",i),!!i&&(i.slug==="full_payment"||i.slug==="full-payment"||String(i.name||"").toLowerCase().includes("full"))?(t("payment_percentage",1),x("payment_percentage",1),g(a.services,a.ppn,a.pph,1)):(t("payment_percentage",0),x("payment_percentage",0),g(a.services,a.ppn,a.pph,0))},children:[e.jsx("option",{value:"",children:"-- Choose Payment --"}),(j.paymentTypes||[]).map(n=>e.jsx("option",{value:n.name,children:n.name},n.id))]})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Payment Percentage (10 = 10%)"}),e.jsx("input",{type:"number",step:"1",min:"0",max:"100",className:"w-full border-gray-300 rounded text-sm font-bold",value:a.payment_percentage?a.payment_percentage*100:"",onChange:n=>{const s=n.target.value,i=s===""?"":Number(s),r=i===""?"":Number(i)/100;t("payment_percentage",r),x("payment_percentage",r),g(a.services,a.ppn,a.pph,r)}})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"PPN"}),e.jsxs("select",{className:"w-full border-gray-300 rounded text-sm",value:a.ppn||0,onChange:n=>h(n.target.value),children:[e.jsx("option",{value:"0",children:"-- No PPN --"}),(j.ppn||[]).map(n=>e.jsx("option",{value:n.rate,children:n.name},n.id))]})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"PPh"}),e.jsxs("select",{className:"w-full border-gray-300 rounded text-sm",value:a.pph||0,onChange:n=>b(n.target.value),children:[e.jsx("option",{value:"0",children:"-- No PPh --"}),(j.pph||[]).map(n=>e.jsx("option",{value:n.rate,children:n.name},n.id))]})]}),e.jsxs("div",{className:"flex flex-col justify-start",children:[e.jsxs("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:["Payment Terms",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsx("textarea",{rows:"3",className:"w-full border-gray-300 rounded text-sm font-bold",value:a.payment_terms||"",onChange:n=>{const s=n.target.value;t("payment_terms",s),x("payment_terms",s)}})]}),e.jsxs("div",{className:"flex flex-col justify-start",children:[e.jsxs("label",{className:"text-[10px] font-bold text-gray-400 uppercase",children:["Note",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsx("textarea",{rows:"3",className:"w-full border-gray-300 rounded text-sm font-bold",value:a.note||"",onChange:n=>{const s=n.target.value;t("note",s),x("note",s)}})]})]})]})},renderPreview:({data:t,addItem:y,removeItem:g,updateField:u})=>(T||setBuilderAddItem(()=>y),P.useEffect(()=>{const o=t.services.reduce((l,d)=>l+Number(d.price||0),0),m=Number(t.ppn)||0,h=Number(t.pph)||0,b=Number(t.payment_percentage||0),n=o*m,s=o*h,i=o*b,r=o+n-s;(t.sub_total!==o||t.total!==r||t.tax_amount_ppn!==n||t.tax_amount_pph!==s||t.down_payment!==i)&&x(l=>({...l,sub_total:o,tax_amount_ppn:n,tax_amount_pph:s,down_payment:i,total:r}))},[t.services,t.ppn,t.pph,t.payment_percentage]),e.jsxs("div",{className:"p-2 text-[12px]",children:[e.jsxs("div",{className:"flex justify-between pb-4 mb-6",children:[e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Number"}),e.jsx("p",{className:"font-bold",children:t.number||"INV-XXXXX"})]}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Date"}),e.jsx("p",{className:"font-bold",children:t.date||"Date Not Set"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-8 mb-8",children:[e.jsx("div",{className:"border border-black p-5 rounded-sm",children:e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"To:"}),e.jsx("p",{className:"font-bold text-emerald-800",children:t.contact_person||"---"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Email:"}),e.jsx("p",{className:"text-black",children:t.email})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Handphone:"}),e.jsx("p",{className:"text-black",children:t.phone})]})]})}),e.jsx("div",{className:"border border-black p-5 rounded-sm",children:e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Company:"}),e.jsx("p",{className:"font-black",children:t.company_name||"---"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase",children:"Address:"}),e.jsx("p",{className:"text-black leading-tight",children:t.address||"No address provided."})]})]})})]}),e.jsx("p",{className:"text-[15px] font-bold text-black mb-2",children:"Services"}),e.jsxs("table",{className:"w-full border-collapse border border-black",children:[e.jsx("thead",{className:"bg-gray-50 uppercase text-[10px] font-black border-b border-black",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 text-center w-8 border border-black",children:"No"}),e.jsx("th",{className:"p-2 text-left border border-black",children:"Description"}),e.jsx("th",{className:"p-2 text-center w-24 border border-black",children:"Qualification"}),e.jsx("th",{className:"p-2 text-right w-32",children:"Price"}),e.jsx("th",{"data-html2canvas-ignore":"true",className:"print:hidden p-2 w-10"})]})}),e.jsx("tbody",{children:t.services.map((o,m)=>e.jsxs("tr",{className:"border-b border-gray-100 relative group",children:[e.jsx("td",{className:"p-2 text-center font-bold text-gray-400 border border-black",children:t.services.indexOf(o)+1}),e.jsx("td",{className:"p-2 font-bold uppercase border border-black",children:o.name}),e.jsx("td",{className:"p-2 text-center border border-black",children:o.processing}),e.jsx("td",{className:"p-2 text-right font-black border-b border-black",children:v(o.price)}),e.jsx("td",{className:"print:hidden p-2 text-center border-b border-black",children:e.jsx("button",{type:"button","data-html2canvas-ignore":"true",onClick:()=>{console.log("ID Item ini adalah:",o.id),g(o.id)},className:"text-red-400 hover:text-red-600 transition-colors",children:e.jsx(K,{size:14})})})]},o.id||m))})]}),e.jsx("div",{"data-html2canvas-ignore":"true",className:"mt-4 flex justify-start print:hidden",children:e.jsx("button",{"data-html2canvas-ignore":"true",onClick:()=>F(!0),className:"flex items-center gap-2 bg-[#065f46] text-white px-4 py-2 rounded-sm text-[10px] font-bold tracking-widest hover:scale-105 transition-all shadow-lg",children:"ADD SERVICE"})}),e.jsxs("div",{className:"mt-10 flex justify-between",children:[e.jsxs("div",{className:"w-1/2",children:[e.jsxs("div",{className:"h-[6rem] mb-5",children:[e.jsx("p",{className:"text-[15px] font-black font-bold mb-1",children:"Payment Terms"}),e.jsx("p",{className:"text-red-600 text-[11px] font-medium leading-tight whitespace-pre-wrap",children:t.payment_terms})]}),e.jsxs("div",{className:"h-[3rem] mb-20",children:[e.jsx("p",{className:"text-[15px] font-black font-bold mb-1",children:"Note"}),e.jsx("p",{className:"text-red-600 text-[11px] font-medium leading-tight whitespace-pre-wrap",children:t.note})]})]}),e.jsxs("div",{className:"w-1/3 space-y-1 font-bold",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:v(t.sub_total||0)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:(()=>{const o=t.payment_percentage?`${(t.payment_percentage*100).toFixed(0)}%`:"",m=Number(t.payment_percentage)===1,h=(j.paymentTypes||[]).find(n=>n.name===t.payment_type||n.slug===t.payment_type||n.name===t.payment_type);return m||h&&(h.slug==="full_payment"||h.slug==="full-payment"||String(h.name||"").toLowerCase().includes("full"))?`Paid in Full ${o?`(${o})`:""}`:`Down Payment ${o}`})()}),e.jsx("span",{children:v(t.down_payment||0)})]}),e.jsxs("div",{className:"flex justify-between text-red-600",children:[e.jsxs("span",{children:["VAT (PPN) ",(()=>{const o=j.ppn||[],m=Number(t.ppn||0),h=o.find(b=>Number(b.rate)===m);return h?h.name:m?`${(m*100).toFixed(0)}%`:""})()]}),e.jsx("span",{children:v(t.tax_amount_ppn||0)})]}),e.jsxs("div",{className:"flex justify-between text-red-600 border-b border-black pb-1",children:[e.jsxs("span",{children:["VAT (PPh) ",(()=>{const o=j.pph||[],m=Number(t.pph||0),h=o.find(b=>Number(b.rate)===m);return h?h.name:m?`${(m*100).toFixed(0)}%`:""})()]}),e.jsx("span",{children:v(t.tax_amount_pph||0)})]}),e.jsxs("div",{className:"flex justify-between text-sm font-black pt-1",children:[e.jsx("span",{children:"TOTAL"}),e.jsx("span",{children:v(t.total||0)})]}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-[16px] uppercase font-black",children:t.my_company_name||D?.company_name||"---"}),e.jsx("div",{className:"h-20"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-[14px] uppercase font-black leading-tight",children:t.prepared_by_name||S?.user?.name||c.creator?.name||"---"}),e.jsx("p",{className:"text-[13px] text-gray-500 leading-tight",children:t.prepared_by_role||S?.user?.role_name||c.creator?.role?.name||"---"})]})]})]})]})]}))})]})}export{ne as default};
